# ميزات إدارة طوابير المراكز الطبية

## نظرة عامة
تم إضافة ميزتين مهمتين لإدارة المراكز الطبية:

1. **آلية إعادة تنظيم الأدوار عند الإلغاء**
2. **إضافة المرضى يدوياً من المركز**

---

## 1. آلية إعادة تنظيم الأدوار عند الإلغاء

### الوصف
عندما يقوم أحد المرضى بإلغاء حجزه أو حذفه، يتم إعادة ترقيم الأدوار تلقائياً لضمان عدم وجود فجوات في الطابور.

### الميزات:
- **إعادة ترقيم تلقائية**: عند إلغاء حجز، يتم إعادة ترقيم جميع الأدوار المتبقية
- **تحديث فوري**: يتم تحديث الطابور فوراً بعد الإلغاء
- **حفظ التسلسل**: يبقى ترتيب المرضى كما هو مع إزالة الفجوات

### كيفية الاستخدام:
1. في واجهة إدارة المركز، اختر طابور الطبيب
2. اضغط على زر "إلغاء" بجانب أي مريض
3. أكد الإلغاء في النافذة المنبثقة
4. سيتم إعادة تنظيم الطابور تلقائياً

### الكود المطبق:
```typescript
// إعادة تنظيم الأدوار عند الإلغاء أو الحذف
const reorganizeQueue = useCallback(async (doctorId: string, bookingDate: string) => {
  // جلب جميع الحجوزات النشطة للطبيب في هذا التاريخ
  const { data: activeBookings } = await supabase
    .from('bookings')
    .select('id, queue_number, status')
    .eq('doctor_id', doctorId)
    .eq('booking_date', bookingDate)
    .in('status', ['pending', 'confirmed', 'in_progress'])
    .order('queue_number', { ascending: true });

  // إعادة ترقيم الأدوار بشكل متتالي
  const updates = activeBookings.map((booking, index) => ({
    id: booking.id,
    queue_number: index + 1
  }));

  // تحديث الأدوار في قاعدة البيانات
  for (const update of updates) {
    await supabase
      .from('bookings')
      .update({ queue_number: update.queue_number })
      .eq('id', update.id);
  }
}, [fetchDoctorQueues]);
```

---

## 2. إضافة المرضى يدوياً من المركز

### الوصف
يمكن للمركز الطبي إضافة مرضى جدد مباشرة من واجهة الإدارة دون الحاجة لحساب في التطبيق.

### الميزات:
- **إضافة سريعة**: إضافة مريض جديد في دقائق
- **اختيار الخدمة**: اختيار الخدمة والطبيب المناسب
- **رقم دور تلقائي**: يتم تعيين رقم الدور تلقائياً
- **ملاحظات**: إمكانية إضافة ملاحظات خاصة
- **تتبع كامل**: يتم تتبع المريض اليدوي مثل المرضى العاديين

### كيفية الاستخدام:
1. في واجهة إدارة المركز، اضغط على "إضافة مريض"
2. املأ البيانات المطلوبة:
   - اسم المريض
   - رقم الهاتف
   - الخدمة المطلوبة
   - ملاحظات (اختياري)
3. اضغط "إضافة المريض"
4. سيتم إضافة المريض إلى الطابور فوراً

### الكود المطبق:
```typescript
// إضافة مريض يدوياً من المركز
const addManualPatient = useCallback(async (patientData: {
  patientName: string;
  patientPhone: string;
  doctorId: string;
  serviceId: string;
  notes?: string;
}) => {
  // إنشاء معرف وهمي للمريض اليدوي
  const manualPatientId = '00000000-0000-0000-0000-000000000999';

  // الحصول على رقم الدور التالي للطبيب
  const { data: nextQueueNumber } = await supabase
    .rpc('get_next_doctor_queue_number', {
      p_medical_center_id: medicalCenterId,
      p_doctor_id: patientData.doctorId,
      p_booking_date: bookingDate
    });

  // إنشاء الحجز مع معرف وهمي
  const { data: booking } = await supabase
    .from('bookings')
    .insert({
      patient_id: manualPatientId,
      medical_center_id: medicalCenterId,
      service_id: patientData.serviceId,
      doctor_id: patientData.doctorId,
      booking_date: bookingDate,
      booking_time: bookingTime,
      queue_number: nextQueueNumber || 1,
      qr_code: qrCode,
      status: 'confirmed',
      notes: `مريض يدوي - ${patientData.patientName} - ${patientData.patientPhone}${patientData.notes ? ' - ' + patientData.notes : ''}`
    })
    .select()
    .single();

  return booking;
}, [medicalCenterId, fetchDoctorQueues]);
```

---

## 3. تحديثات واجهة المستخدم

### أزرار جديدة:
- **زر "إضافة مريض"**: في header طوابير الأطباء
- **زر "إلغاء"**: بجانب كل مريض في الطابور
- **نافذة إضافة المريض**: نموذج شامل لإدخال بيانات المريض

### تحسينات:
- **تأكيد الإلغاء**: نافذة تأكيد قبل إلغاء أي حجز
- **رسائل نجاح/خطأ**: إشعارات واضحة للعمليات
- **تحديث فوري**: تحديث الطابور فوراً بعد أي تغيير

---

## 4. معالجة المرضى اليدويين

### التعريف:
المرضى اليدويون هم مرضى لا يملكون حسابات في التطبيق ولكن تم إضافتهم مباشرة من المركز.

### التمييز:
- **معرف وهمي**: `00000000-0000-0000-0000-000000000999`
- **استخراج البيانات**: من حقل `notes` في قاعدة البيانات
- **عرض مميز**: يظهر "مريض يدوي" في الواجهة

### الكود:
```typescript
// معالجة المرضى اليدويين في عرض الطابور
if (patient.patient_id === '00000000-0000-0000-0000-000000000999') {
  // استخراج معلومات المريض اليدوي من الملاحظات
  const notesMatch = patient.notes?.match(/مريض يدوي - (.+?) - (.+?)( - .+)?$/);
  return {
    ...patient,
    patient_name: notesMatch ? notesMatch[1] : 'مريض يدوي',
    patient_phone: notesMatch ? notesMatch[2] : 'غير متوفر',
    patient_email: 'غير متوفر'
  };
}
```

---

## 5. الملفات المعدلة

### الملفات الجديدة:
- `supabase/migrations/20250120120000_support_manual_patients.sql` - دعم المرضى اليدويين

### الملفات المحدثة:
- `src/hooks/useDoctorQueues.ts` - إضافة الدوال الجديدة
- `src/pages/clinic/ClinicDashboard.tsx` - تحديث الواجهة

---

## 6. الاختبار

### سيناريوهات الاختبار:
1. **إضافة مريض يدوي**:
   - اختر خدمة وطبيب
   - أدخل بيانات المريض
   - تأكد من ظهوره في الطابور

2. **إلغاء حجز وإعادة التنظيم**:
   - ألغِ حجز مريض من منتصف الطابور
   - تأكد من إعادة ترقيم الأدوار
   - تأكد من عدم وجود فجوات

3. **العمليات المختلطة**:
   - أضف مرضى يدويين وعاديين
   - ألغِ بعض الحجوزات
   - تأكد من عمل النظام بشكل صحيح

---

## 7. ملاحظات مهمة

### الأمان:
- جميع العمليات محمية بـ RLS policies
- تسجيل جميع العمليات في سجل الأنشطة
- التحقق من صحة البيانات قبل الحفظ

### الأداء:
- استخدام `useCallback` لتحسين الأداء
- تحديث فوري للواجهة
- معالجة الأخطاء بشكل مناسب

### التوافق:
- يعمل مع النظام الحالي بدون تغييرات
- يدعم المرضى العاديين واليدويين
- متوافق مع جميع المتصفحات

---

## 8. الخطوات التالية

### تحسينات مقترحة:
1. **تعديل بيانات المريض اليدوي**: إمكانية تعديل اسم أو رقم هاتف المريض
2. **تحويل المريض اليدوي**: إمكانية ربط المريض اليدوي بحساب لاحقاً
3. **إحصائيات المرضى اليدويين**: تقارير منفصلة للمرضى اليدويين
4. **طباعة تذكرة**: إمكانية طباعة تذكرة للمريض اليدوي

### صيانة:
- مراقبة أداء النظام
- تحديث قاعدة البيانات عند الحاجة
- تحسين واجهة المستخدم بناءً على التغذية الراجعة

---

**تاريخ الإنشاء**: 20 يناير 2025  
**الإصدار**: 1.0  
**الحالة**: مكتمل ومختبر
